<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PMC</title>
  <link rel="icon" href="png/pmcjpeg.png" type="image/x-icon" />

  <!-- External CSS -->
  <link rel="stylesheet" href="css/geometry.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

  <!-- External JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

  <style>
    .pagination {
      margin-top: 3px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .pagination button {
      display: inline-block;
      width: 30px;
      height: 30px;
      padding: 0;
      margin: 0 5px;
      background-color: transparent;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }

    .pagination button:hover {
      background-color: #007bff;
      /* border: 1px solid black; */
    }

    .pagination button.active {
      width: 35px;
      height: 35px;
      padding: 0;
      background-color: #007bff;
      color: white;
      border: 2px solid #007bff;
      border-radius: 50%;
    }

    .pagination .arrow {
      background-color: transparent;
      border: none;
    }

    .pagination .arrow:hover {
      background-color: transparent !important;
      color: inherit;
    }

    .pagination .arrow:focus {
      outline: none;
    }

    @media print {
      body {
        size: tabloid landscape;
        margin: 10mm 10mm 10mm 10mm;
      }

      .pagination,
      .geopulseaname,
      #generatePdfBtn {
        display: none;
      }

      table {
        width: 100%;
        font-size: 10pt;
      }
    }

    .edit-button {
      display: inline-block;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      font-size: 10px;
      font-weight: bold;
      padding: 5px;
      margin-left: 88%;

      font-family: sans-serif !important;
      transition: background-color 0.3s ease;
    }


    .edit-button:hover {
      background-color: #0056b3;
    }

    .edit i {
      margin-right: 10px;
    }

    .leaflet-interactive {
      transform: scale(1.2);
    }
  </style>


</head>

<body class="bg-light">
  <img src="png/pmcjpeg.png" alt="" class="logopng1" />
  <div id="content" style="width: 100%" class="container">
    <div id="button-container" class=""></div>

    <section id="map-section" class="">
      <form class="mt-3" style="overflow: hidden">
        <div style="margin: 0; float: left">
          <h5 class="text-secondary">Preview Map</h5>

        </div>
        <div style="float: right; margin-top: -40px; margin-left: 95%">
          <i class="fa-solid fa-print text-primary" id="generatePdfBtn" onclick="printPage()"
            style="font-size: 25px"></i>
        </div>
        <div id="map"></div>
        <a class="geopulseaname"
          style="color: darkblue; position: absolute; z-index: 99999; bottom: 0.5%; right: 0; font-weight: bold; font-size: 10px;">@GeoPulse
          Analytics</a>
        <div id="table-container">
          <table id="workTable" class="table table-bordered table-hover"
            style="width: 100% !important; font-size: 10px">
            <thead>
              <tr>
                <th>Attribute</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="workTableData">
            </tbody>
          </table>
          <div id="pagination-controls" class="pagination">

          </div>
      </form>
    </section>
  </div>

  <script>
    // Initialize the map
    var map = L.map("map", {
      center: [18.52, 73.89],
      zoom: 8,
      minZoom: 9,
      maxZoom: 16,
      boxZoom: true,
      trackResize: true,
      wheelPxPerZoomLevel: 40,
      zoomAnimation: true,
      dragging: true,
      zoomControl: false,
      scrollWheelZoom: true,
      doubleClickZoom: false,
      touchZoom: false
    });
  
    // Define tile layers
    var googleSat = L.tileLayer("http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
      maxZoom: 20,
      subdomains: ["mt0", "mt1", "mt2", "mt3"]
    });
  
    var Esri_WorldImagery = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      maxZoom: 20
    });
  
    var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);
  
    // Define WMS layers
    var baseURL = "https://iwmsgis.pmc.gov.in/geoserver/PMC_test/wms";
  
    var plot1_layouts_test = L.tileLayer.wms(baseURL, {
      layers: "plot1_layouts_test",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    });
  
    var WMSlayers = {
      "Esri": Esri_WorldImagery,
      "Satellite": googleSat,
      "osm": osm,
      "plot1_layouts_test": plot1_layouts_test,
    };
  
    // Add layer control
    var control = new L.control.layers({}, WMSlayers).addTo(map);
    control.setPosition('topright');
  
    var highlightLayer;
  
    const API_URL = "https://iwmsgis.pmc.gov.in/geoserver/PMC_test/wms"; // Updated to remote URL
  
    $(document).ready(function () {
      // Parse URL parameters
      var urlParams = new URLSearchParams(window.location.search);
      var villageName = urlParams.get('token'); // Ensure 'token' is lowercase in URL
      console.log("villageName:", villageName);
  
      if (!villageName) {
        alert("No token provided in the URL.");
        return;
      }
  
      // Define the filter correctly
      var filter = "token = '" + villageName + "'";
      console.log("CQL_FILTER:", filter);
  
      // Set WMS parameters with the correct filter
      plot1_layouts_test.setParams({ CQL_FILTER: filter, maxZoom: 19.5, styles: "plot1_layouts_test" }).addTo(map);
  
      // Fetch data based on the filter
      getdata(filter);
  
      function getdata(filters) {
        console.log("Fetching data with filter:", filters);
        const layers = ["PMC_test:plot1_layouts_test"];
        const promises = [];
        const layerDetails = ["id", "token", "ownerinformation_firstname", "ownerinformation_address", "ownerinformation_contactdetails", "caseinformation_applyfor", "caseinformation_proposaltype", "caseinformation_tdrzone", "caseinformation_area", "caseinformation_grossplotarea", "entry_timestamp"];
  
        layers.forEach(function (layerName) {
          const urlm = `https://iwmsgis.pmc.gov.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=${encodeURIComponent(layerName)}&CQL_FILTER=${encodeURIComponent(filters)}&outputFormat=application/json`;
  
          console.log("WFS URL:", urlm);
  
          $('#table-container').show();
  
          const promise = $.getJSON(urlm).then(function (data) {
            return data.features.map(feature => {
              const properties = feature.properties;
              let filteredData = {};
              layerDetails.forEach(key => {
                if (properties[key] !== undefined && properties[key] !== null) {
                  filteredData[key] = properties[key];
                } else if (feature[key] !== undefined) {
                  filteredData[key] = JSON.stringify(feature[key]);
                }
              });
              filteredData.geometry = feature.geometry;
              return filteredData;
            });
          }).catch(function (error) {
            console.error("Error fetching data from WFS:", error);
            return [];
          });
  
          promises.push(promise);
        });
  
        Promise.all(promises).then(function (results) {
          const flattenedResults = results.flat();
          console.log("Fetched Data:", flattenedResults);
          paginateResults(flattenedResults);
        }).catch(function (error) {
          console.error("An error occurred in Promise.all:", error);
        });
      }
  
      function paginateResults(data) {
        const itemsPerPage = 1;
        let currentPage = 1;
  
        function displayPage(page) {
          console.log("Displaying page:", page);
          const tableBody = document.getElementById('workTableData');
          tableBody.innerHTML = '';
  
          if (data.length === 0) {
            const emptyMessage = document.createElement('tr');
            emptyMessage.className = 'empty-message';
            emptyMessage.innerHTML = '<td colspan="2">No data available.</td>';
            tableBody.appendChild(emptyMessage);
            return;
          }
  
          const start = (page - 1) * itemsPerPage;
          const end = Math.min(start + itemsPerPage, data.length);
          for (let i = start; i < end; i++) {
            const item = data[i];
            for (const [key, value] of Object.entries(item)) {
              if (key !== "geometry") {
                const row = document.createElement('tr');
                const displayValue = key === 'length_1' ? parseFloat(value).toFixed(2) : value;
                row.innerHTML = `<td>${key}</td><td>${displayValue}</td>`;
                tableBody.appendChild(row);
              }
            }
          }
  
          const paginationControls = document.getElementById('pagination-controls');
          paginationControls.innerHTML = '';
          highlightFeature(data[start].geometry);
          updatePagination(page);
        }
  
        function updatePagination(page) {
          const paginationControls = document.getElementById('pagination-controls');
          paginationControls.innerHTML = '';
  
          const totalPages = Math.ceil(data.length / itemsPerPage);
          console.log("Total Pages:", totalPages);
  
          // Previous Button
          const prevButton = document.createElement('button');
          prevButton.innerHTML = '<';
          prevButton.classList.add('arrow');
          prevButton.disabled = page === 1;
          prevButton.addEventListener('click', () => {
            if (page > 1) {
              displayPage(page - 1);
            }
          });
          paginationControls.appendChild(prevButton);
  
          // Page Numbers
          const maxVisiblePages = 5;
          let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
          let endPage = startPage + maxVisiblePages - 1;
          if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
          }
  
          for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.classList.add('page-num');
            if (i === page) {
              button.classList.add('active');
            }
            button.addEventListener('click', () => {
              displayPage(i);
            });
            paginationControls.appendChild(button);
          }
  
          // Next Button
          const nextButton = document.createElement('button');
          nextButton.innerHTML = '>';
          nextButton.classList.add('arrow');
          nextButton.disabled = page === totalPages;
          nextButton.addEventListener('click', () => {
            if (page < totalPages) {
              displayPage(page + 1);
            }
          });
          paginationControls.appendChild(nextButton);
        }
  
        function highlightFeature(geometry) {
          if (highlightLayer) {
            map.removeLayer(highlightLayer);
          }
          highlightLayer = L.geoJSON(geometry, {
            style: {
              color: '#0000FF',
              weight: 5,
              opacity: 0.65
            }
          }).addTo(map);
          map.fitBounds(highlightLayer.getBounds());
        }
  
        // Display initial page
        displayPage(currentPage);
      }
  
      // Define printPage function
      function printPage() {
        window.print();
      }
  
      // Assign onclick event using jQuery
      $('#generatePdfBtn').on('click', printPage);
    });
  </script>
  
</body>

</html>