<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PMC</title>
    <link rel="icon" href="png/pmcjpeg.png" type="image/x-icon" />

    <!-- External CSS -->
    <link rel="stylesheet" href="css/geometry.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

    <!-- External JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

</head>

<body class="bg-light">
    <img src="image/pmcjpeg.png" alt="" class="logopng1" />
    <div id="content" style="width: 100%" class="container">
        <div id="button-container" class=""></div>

        <section id="map-section" class="">
            <form class="mt-3" style="overflow: hidden">
                <div style="margin: 0; float: left">
                    <h5 class="text-secondary">Preview Map</h5>

                </div>
                <div id="printContainer">
                    <i class="fa-solid fa-print" id="generatePdfBtn" onclick="printPage()"></i> 
                </div>
                
                <div id="map"></div>
                <a class="geopulseaname">@GeoPulse Analytics</a>

                <div id="table-container">
                    <table id="workTable" class="table table-bordered table-hover"
                        style="width: 100% !important; font-size: 10px">
                        <thead>
                            <tr>
                                <th>Attribute</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="workTableData">
                        </tbody>
                    </table>
                    <div id="pagination-controls" class="pagination">      
                    </div>
            </form>
        </section>
    </div>
    
    <script>

      // print all window
       $(document).ready(function () {
            // Your existing document ready code...

            function printPage() {
                window.print();
            }

            // Move the onclick assignment inside the document ready block
            document.getElementById("generatePdfBtn").onclick = printPage;
        });


//maplayer 
var map = L.map("map", {
      center: [18.52, 73.89],
      zoom: 12,
      minZoom: 11,
      maxZoom: 18,
      boxZoom: true,
      trackResize: true,
      wheelPxPerZoomLevel: 40,
      zoomAnimation: true
    });
    
    var googleSat = L.tileLayer(
      "http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
      {
        maxZoom: 20,
        subdomains: ["mt0", "mt1", "mt2", "mt3"]
      }
    );
    
    var stamen = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'
    ).addTo(map);
    
    var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
    
    var Esri_WorldImagery = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
    );
    
    var PlotBoundary_Layer = L.tileLayer.wms("https://iwmsgis.pmc.gov.in/geoserver/AutoDCR/wms", {
      layers: "auto_test",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    }).addTo(map);
    
    var Revenue_Layer = L.tileLayer.wms("https://iwmsgis.pmc.gov.in/geoserver/AutoDCR/wms", {
      layers: "Revenue_1",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    });
    
    var Revenue_Layer1 = L.tileLayer.wms("https://iwmsgis.pmc.gov.in/geoserver/AutoDCR/wms", {
      layers: "Revenue_1",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    });
    
    var PLU_Layer = L.tileLayer.wms("https://iwmsgis.pmc.gov.in/geoserver/AutoDCR/wms", {
      layers: "PLU_Ward",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    });
    
    var DPRoad_Layer = L.tileLayer.wms("https://iwmsgis.pmc.gov.in/geoserver/AutoDCR/wms", {
      layers: "DP_Ward_Road",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    });
    
    var Boundary_Layer = L.tileLayer.wms("https://iwmsgis.pmc.gov.in/geoserver/AutoDCR/wms", {
      layers: "PMC_Boundary",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    }).addTo(map);
    
    var Village_Boundary = L.tileLayer.wms("https://iwmsgis.pmc.gov.in/geoserver/AutoDCR/wms", {
      layers: "Village_Boundary",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      opacity: 1
    });

    var auto_test = L.tileLayer.wms(
    "https://iwmsgis.pmc.gov.in/geoserver/wms",
    {
      layers: "auto_test",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      maxZoom: 21,
      opacity: 1,
    }
  ).addTo(map);
  var Zone_layer = L.tileLayer.wms(
    "https://iwmsgis.pmc.gov.in/geoserver/wms",
    {
      layers: "Zone_layer",
      format: "image/png",
      transparent: true,
      tiled: true,
      version: "1.1.0",
      maxZoom: 21,
      opacity: 1,
    }
  ).addTo(map);
    
    var baseLayers = {
      "OSM": osm,
      "Esri": Esri_WorldImagery,
      "Satellite": googleSat,
      "stamen": stamen,
    };
    
    var overlayLayers = {
      "Plot": PlotBoundary_Layer,
      "Boundary": Boundary_Layer,
      "Village": Village_Boundary,
      "Zone_layer":Zone_layer,
      "auto_test":auto_test,
    };
    
    L.control.layers(baseLayers, overlayLayers).addTo(map);
    
    map.on("zoomend", function() {
      if (map.getZoom() > 17.2) {
        if (!map.hasLayer( googleSat)) {
          map.removeLayer(stamen);
          map.addLayer( googleSat);
        }
      } else {
        if (!map.hasLayer(stamen)) {
          map.removeLayer( googleSat  );
          map.addLayer(stamen);
        }
      }
    });
   

    

    // table 
    
    $(document).ready(function () {
    var urlParams = new URLSearchParams(window.location.search);
    var villageName = urlParams.get('Token');  // Handle null Token
    var filter = "Token =' " + villageName+"'"; // Add single quotes for the filter

    console.log(villageName, "Token", filter);

    // Call the getdata function to load data based on the filter
    getdata(filter);

    // Function to get data from the API and display in the table
    function getdata(filters) {
        const layers = ["pmc:IWMS_line", "pmc:IWMS_polygon", "pmc:IWMS_point", "pmc:GIS_Ward_Layer"];
        const promises = [];
        const layerDetails = ["id", "Token", "Name_of_Work", "Department", "Project_Office", "zone", "ward", "Tender_Amount", "Name_of_JE", "length_1", "width", "area", "geometry"];

        layers.forEach(function (layerName) {
            const urlm = "https://iwmsgis.pmc.gov.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=" +
                layerName +
                "&CQL_FILTER=" +
                filters +
                "&outputFormat=application/json";
                

            $('#table-container').show();

            const promise = $.getJSON(urlm).then(function (data) {
                return data.features.map(feature => {
                    const properties = feature.properties;
                    let filteredData = {};
                    layerDetails.forEach(key => {
                        if (properties[key] !== undefined && properties[key] !== null) {
                            filteredData[key] = properties[key];
                        } else if (feature[key] !== undefined) {
                            filteredData[key] = JSON.stringify(feature[key]);
                        }
                    });
                    filteredData.geometry = feature.geometry;
                    return filteredData;
                });
            });

            promises.push(promise);
        });

        // Handle all the promises (data loading from all layers)
        Promise.all(promises).then(function (results) {
            const flattenedResults = results.flat();
            paginateResults(flattenedResults);
        }).catch(function (error) {
            console.error("An error occurred: ", error);
        });
    }

    // Pagination and table display logic
    function paginateResults(data) {
        const itemsPerPage = 5;  // Adjust the number of items per page as needed
        let currentPage = 1;

        // Function to display data on the current page
        function displayPage(page) {
            const tableBody = document.getElementById('workTableData');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                const emptyMessage = document.createElement('tr');
                emptyMessage.className = 'empty-message';
                emptyMessage.innerHTML = '<td colspan="2">No data available.</td>';
                tableBody.appendChild(emptyMessage);
                return;
            }

            // Calculate start and end for current page
            const start = (page - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, data.length);

            for (let i = start; i < end; i++) {
                const item = data[i];

                // Display each key-value pair from the item
                for (const [key, value] of Object.entries(item)) {
                    if (key !== "geometry") {
                        const row = document.createElement('tr');
                        const displayValue = key === 'length_1' ? parseFloat(value).toFixed(2) : value;
                        row.innerHTML = `<td>${key}</td><td>${displayValue}</td>`;
                        tableBody.appendChild(row);
                    }
                }
            }

            // Add an edit button to the table for each entry
            const editRow = document.createElement('tr');
            editRow.classList.add('no-bottom-border');
            const editButtonCell = document.createElement('td');
            editButtonCell.colSpan = 2;
            editButtonCell.style.textAlign = 'center';

            const department = data[page - 1].Department.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const id = data[page - 1].id;
            const Work_ID = data[page - 1].Token || villageName;  // Use the Token or villageName as Work_ID

            editButtonCell.innerHTML = `<button type="button" onclick="onClickEdit('${department}', '${id}', '${Work_ID}')" class="edit-button"><i class="fas fa-pen"></i>&nbsp;Edit</button>`;

            editRow.appendChild(editButtonCell);
            tableBody.appendChild(editRow);

            const paginationControls = document.getElementById('pagination-controls');
            paginationControls.innerHTML = '';

            // Highlight the feature on the map (if available)
            highlightFeature(data[start].geometry);

            // Update the pagination controls
            updatePagination(page);
        }

        // Function to update pagination
        function updatePagination(page) {
            const paginationControls = document.getElementById('pagination-controls');
            paginationControls.innerHTML = '';

            const totalPages = Math.ceil(data.length / itemsPerPage);

            // Create previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<';
            prevButton.classList.add('arrow');
            prevButton.disabled = page === 1;
            prevButton.addEventListener('click', () => {
                if (page > 1) {
                    displayPage(page - 1);
                }
            });
            paginationControls.appendChild(prevButton);

            const maxVisiblePages = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
            let endPage = startPage + maxVisiblePages - 1;
            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // Create page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.add('page-num');
                if (i === page) {
                    button.style.fontWeight = 'bold';
                }
                button.addEventListener('click', () => {
                    displayPage(i);
                });
                paginationControls.appendChild(button);
            }

            // Create next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '>';
            nextButton.classList.add('arrow');
            nextButton.disabled = page === totalPages;
            nextButton.addEventListener('click', () => {
                if (page < totalPages) {
                    displayPage(page + 1);
                }
            });
            paginationControls.appendChild(nextButton);
        }

        // Function to highlight feature on the map
        function highlightFeature(geometry) {
            if (highlightLayer) {
                map.removeLayer(highlightLayer);
            }
            highlightLayer = L.geoJSON(geometry, {
                style: {
                    color: '#0000FF',
                    weight: 5,
                    opacity: 0.65
                }
            }).addTo(map);
            map.fitBounds(highlightLayer.getBounds());
        }

        // Display the first page initially
        displayPage(currentPage);
    }
});
  



    </script>
</body>
</html>
